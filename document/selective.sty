% This file is part of eclecTeX, a multi-purpose LaTeX library.
%
% © 2009-2013 Sebastián González Montesinos.
%
% This work may be distributed and/or modified under the conditions of
% the LaTeX Project Public License version 1.3 or later.
%
% This work has the LPPL maintenance status `maintained'.
% The Current Maintainer of this work is Sebastián González.

\NeedsTeXFormat{LaTeX2e}[1999/12/01]

\ProvidesPackage{eclectex/document/selective}
  [2013/07/11 v0.0 Utilities to selectively typeset tagged text.]

\ProcessOptions\relax

%---[ Packages ]---

\RequirePackage{eclectex/lists}

\RequirePackage{environ}
\RequirePackage{pgffor}

%---[ Commands ]---

\def\selective@tags{} % current list of tags

\newif\if@body@tags@found
\newif\if@selective@tag@found

% Expects a list {a1,a2,a3,...},{b1,b2,b3,...},...,{c1,c2,c3,...}
% Interpreted as a conjunction (AND) of the different disjunctions (OR).
\NewEnviron{selective}[1]
  {\def\tagConjunctions{#1}%
   \@body@tags@foundtrue%
   \foreach \tagDisjuction in \tagConjunctions
     {\@selective@tag@foundfalse%
      \foreach \activeTag in \selective@tags
        {\foreach \bodyTag in \tagDisjuction
           {\ifdefstrequal{\activeTag}{\bodyTag}
              {\global\@selective@tag@foundtrue\breakforeach}{}}}%
      \if@selective@tag@found\else%
        \global\@body@tags@foundfalse\breakforeach%
      \fi}%
   \if@body@tags@found%
     \BODY%
   \fi}

\newcommand{\selectiveTag}[1]
  {\listInclude{\selective@tags}{#1}%
   \edef\implied@tags{\csuse{#1@tag@implications}}%
   %\ifcsvoid{#1@tag@implications}{}
   \foreach \implied@tag in \implied@tags
     {\selectiveTag{\implied@tag}}}

\newcommand{\selectiveTagImplies}[2]
  {\csdef{#1@tag@implications}{#2}}
